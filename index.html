<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheezy Treats PriceList</title>
    <style>
        /* Ibinabalik ang iyong orihinal na design */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 10px; margin: 0; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 650px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        h2 { text-align: center; color: #1a73e8; margin-top: 5px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 10px; border: 1px solid #eee; }
        #adminSection { display: none; margin-bottom: 20px; }
        .input-group { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #eef0f2; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 10px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; }
        #addBtn { background: #28a745; width: 100%; }
        .summary-card { background: #1a73e8; color: white; padding: 15px; border-radius: 10px; margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .summary-item { text-align: center; }
        .summary-val { display: block; font-size: 1.2rem; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .product-img { width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer; }
        .status-badge { font-size: 9px; padding: 2px 5px; border-radius: 4px; color: white; font-weight: bold; }
        .in-stock { background: #28a745; }
        .out-stock { background: #dc3545; }
        .price-tag { font-weight: bold; color: #28a745; }
        .delete-btn { color: #dc3545; font-size: 22px; border: none; background: none; cursor: pointer; }
        .no-print { display: block; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Treats Cheezy PriceList</h2>

    <div class="admin-header no-print">
        <span id="adminStatus">Mode: View Only</span>
        <button id="loginBtn" onclick="toggleAdmin()" style="background:#444;">Admin Login</button>
    </div>

    <div id="adminSection" class="no-print">
        <div class="input-group">
            <input type="text" id="itemName" placeholder="Item Name">
            <div class="row">
                <input type="text" id="itemQty" placeholder="Unit (e.g. Box)">
                <input type="number" id="itemPrice" placeholder="Retail Price">
            </div>
            <div class="row">
                <select id="itemStatus">
                    <option value="In Stock">In Stock</option>
                    <option value="Out of Stock">Out of Stock</option>
                </select>
                <input type="date" id="itemExpiry">
            </div>
            <input type="text" id="itemImageLink" placeholder="Image URL (e.g. https://imgur.com/...)">
            <p style="font-size: 10px; color: #666; margin: 0;">Tip: I-upload ang image sa Imgur at i-paste ang link dito.</p>
            <button id="addBtn" onclick="addNewProduct()">+ Add Product</button>
        </div>
    </div>

    <div class="no-print">
        <div class="btn-row">
            <button style="background:#007bff" onclick="exportToExcel()">Excel</button>
            <button style="background:#6c757d" onclick="window.print()">Print</button>
            <button style="background:#dc3545" id="clearBtn" onclick="clearAll()" style="display:none;">Clear All</button>
        </div>
        <input type="text" id="searchInput" onkeyup="searchFunction()" placeholder="Search catalog...">
    </div>

    <div class="summary-card">
        <div class="summary-item"><span style="font-size:10px">Total Items</span><span class="summary-val" id="totalItems">0</span></div>
        <div class="summary-item"><span style="font-size:10px">Inventory Value</span><span class="summary-val" id="totalValue">â‚±0</span></div>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th style="width: 60px;">Photo</th>
                    <th>Details</th>
                    <th>Price</th>
                    <th id="actionHead" style="display:none;"></th>
                </tr>
            </thead>
            <tbody id="productBody"></tbody>
        </table>
    </div>
</div>
    <th class="view-only-cell">Order</th>

<div id="basketFloat" onclick="toggleBasketModal()" style="position:fixed; bottom:20px; right:20px; background:#28a745; color:white; padding:15px; border-radius:50%; shadow: 0 4px 10px rgba(0,0,0,0.3); cursor:pointer; display:none; z-index:999;">
    ðŸ›’ <span id="basketCount">0</span>
</div>

<div id="basketModal" class="modal" onclick="toggleBasketModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="padding:20px;">
        <h3>Ang Iyong Basket</h3>
        <div id="basketItems"></div>
        <hr>
        <p><strong>Total: â‚±<span id="basketTotal">0</span></strong></p>
        <button onclick="sendOrder()" style="background:#28a745; width:100%; padding:10px;">I-send ang Order via WhatsApp</button>
        <button onclick="toggleBasketModal()" style="background:#6c757d; width:100%; margin-top:10px;">Close</button>
    </div>
</div>
    

<script>
    let isAdmin = false;
    const JSON_URL = 'products.json'; 
    const ADMIN_PASSWORD = "123"; // Maaari mong palitan ito

    // CHECK LOGIN STATUS PAGBUKAS NG PAGE
    document.addEventListener('DOMContentLoaded', () => {
        const savedLogin = localStorage.getItem('adminLoggedIn');
        if (savedLogin === 'true') {
            isAdmin = true;
            applyAdminUI();
        }
        loadData();
    });

    // LOAD DATA MULA SA GITHUB (LIVE)
    async function loadData() {
        try {
            // Nagdagdag ng cache-buster para laging fresh ang data mula sa GitHub
            const res = await fetch(JSON_URL + '?nocache=' + new Date().getTime());
            if (!res.ok) throw new Error();
            const data = await res.json();
            displayItems(data);
        } catch (e) {
            console.log("Naghihintay ng products.json file sa GitHub...");
            document.getElementById('productBody').innerHTML = "<tr><td colspan='3' style='text-align:center'>Wala pang products. I-update ang products.json sa GitHub.</td></tr>";
        }
    }

    function displayItems(items) {
        let tableBody = document.getElementById('productBody');
        let totalVal = 0;
        tableBody.innerHTML = '';
        
        // Ipakita ang "Action" column kung admin
        document.getElementById('actionHead').style.display = isAdmin ? "table-cell" : "none";

        items.forEach((item, index) => {
            totalVal += Number(item.price);
            let statusClass = item.status === "In Stock" ? "in-stock" : "out-stock";
            let img = item.image || 'https://via.placeholder.com/50';

            tableBody.innerHTML += `
                <tr>
                    <td><img src="${img}" class="product-img"></td>
                    <td>
                        <strong>${item.name}</strong> <span class="status-badge ${statusClass}">${item.status}</span><br>
                        <small style="color:#666">${item.qty || ''}</small>
                        ${item.expiry ? `<br><small style="color:#dc3545; font-weight:bold">EXP: ${item.expiry}</small>` : ''}
                    </td>
                    <td class="price-tag">â‚±${Number(item.price).toLocaleString()}</td>
                    <td style="display: ${isAdmin ? 'table-cell' : 'none'}">
                        <button class="delete-btn" onclick="deleteItemPrompt()">&times;</button>
                    </td>
                </tr>
            `;
        });
        document.getElementById('totalItems').innerText = items.length;
        document.getElementById('totalValue').innerText = "â‚±" + totalVal.toLocaleString();
    }

    // TOGGLE ADMIN WITH PERMANENT STORAGE
    function toggleAdmin() {
        if (!isAdmin) {
            let pass = prompt("Enter Admin Password:");
            if (pass === ADMIN_PASSWORD) {
                isAdmin = true;
                localStorage.setItem('adminLoggedIn', 'true');
                applyAdminUI();
                loadData();
            } else if (pass !== null) {
                alert("Maling password!");
            }
        } else {
            if(confirm("Gusto mo bang mag-logout?")) {
                isAdmin = false;
                localStorage.removeItem('adminLoggedIn');
                location.reload(); // Refresh para bumalik sa View Only mode
            }
        }
    }

    function applyAdminUI() {
        document.getElementById('adminSection').style.display = "block";
        document.getElementById('adminStatus').innerText = "Mode: Admin (Logged In)";
        document.getElementById('loginBtn').innerText = "Logout";
        document.getElementById('loginBtn').style.background = "#dc3545";
        const clearBtn = document.getElementById('clearBtn');
        if(clearBtn) clearBtn.style.display = "block";
    }

    async function deleteItem(index) {
    if(!confirm("Sigurado ka bang buburahin ito sa Live listahan?")) return;

    try {
        const getRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
            headers: { "Authorization": `token ${GITHUB_TOKEN}` }
        });
        const fileData = await getRes.json();
        let items = JSON.parse(atob(fileData.content));

        items.splice(index, 1); // Tanggalin ang item base sa index

        await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
            method: "PUT",
            headers: { "Authorization": `token ${GITHUB_TOKEN}` },
            body: JSON.stringify({
                message: "Deleted an item",
                content: btoa(JSON.stringify(items, null, 2)),
                sha: fileData.sha
            })
        });
        location.reload();
    } catch (e) {
        alert("Error deleting item.");
    }
}


    function searchFunction() {
        let input = document.getElementById('searchInput').value.toUpperCase();
        let rows = document.getElementById('productBody').getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.textContent.toUpperCase().includes(input) ? "" : "none";
        }
    }

    // --- CONFIGURATION ---
const GITHUB_TOKEN = "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"; // Ang token na ginawa mo sa Step 1
const GITHUB_USERNAME = "salva15";
const REPO_NAME = "Orenso-Pricelist"; // Pangalan ng repository mo
const FILE_PATH = "products.json";

// --- AUTOMATIC LIVE SAVE FUNCTION ---
async function addNewProduct() {
    const name = document.getElementById('itemName').value;
    const price = document.getElementById('itemPrice').value;
    
    if(!name || !price) return alert("Paki-puno ang Name at Price.");

    const newItem = {
        name: name,
        qty: document.getElementById('itemQty').value,
        price: price,
        status: document.getElementById('itemStatus').value,
        expiry: document.getElementById('itemExpiry').value,
        image: document.getElementById('itemImageLink').value
    };

    const addBtn = document.getElementById('addBtn');
    addBtn.innerText = "Saving to GitHub...";
    addBtn.disabled = true;

    try {
        // 1. Kunin ang kasalukuyang laman ng products.json at ang 'sha' (ID) nito
        const getRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
            headers: { "Authorization": `token ${GITHUB_TOKEN}` }
        });
        const fileData = await getRes.json();
        const currentContent = JSON.parse(atob(fileData.content)); // decode base64

        // 2. Idagdag ang bagong item sa listahan
        currentContent.push(newItem);

        // 3. I-save pabalik sa GitHub
        const putRes = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FILE_PATH}`, {
            method: "PUT",
            headers: {
                "Authorization": `token ${GITHUB_TOKEN}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: `Added new item: ${name}`,
                content: btoa(JSON.stringify(currentContent, null, 2)), // encode to base64
                sha: fileData.sha // kailangan ito para payagan ang update
            })
        });

        if(putRes.ok) {
            alert("Success! Live na ang bagong product.");
            location.reload(); // I-refresh para makita ang pagbabago
        } else {
            throw new Error();
        }
    } catch (error) {
        console.error(error);
        alert("Nagkaroon ng error sa pag-save. Check your Token or Internet.");
    } finally {
        addBtn.innerText = "+ Add Product";
        addBtn.disabled = false;
    }
}
    let basket = [];
const ADMIN_PHONE = "639123456789"; // PALITAN MO ITO NG IYONG NUMBER (Dapat simula sa 63)

// Function para ipakita ang Order Button sa Viewers
function displayItems(items) {
    let tableBody = document.getElementById('productBody');
    tableBody.innerHTML = '';
    
    items.forEach((item, index) => {
        let statusClass = item.status === "In Stock" ? "in-stock" : "out-stock";
        let isOutOfStock = item.status !== "In Stock";

        tableBody.innerHTML += `
            <tr>
                <td><img src="${item.image || 'https://via.placeholder.com/50'}" class="product-img"></td>
                <td>
                    <strong>${item.name}</strong><br>
                    <span class="status-badge ${statusClass}">${item.status}</span>
                </td>
                <td class="price-tag">â‚±${Number(item.price).toLocaleString()}</td>
                <td>
                    ${!isAdmin ? `
                        <button onclick="addToBasket(${index}, '${item.name}', ${item.price})" 
                                style="background:#1a73e8; padding:5px 10px; font-size:12px;"
                                ${isOutOfStock ? 'disabled style="background:#ccc"' : ''}>
                            + Basket
                        </button>` : ''}
                    ${isAdmin ? `<button class="delete-btn" onclick="deleteItem(${index})">&times;</button>` : ''}
                </td>
            </tr>
        `;
    });
}

function addToBasket(id, name, price) {
    basket.push({ id, name, price });
    updateBasketUI();
    document.getElementById('basketFloat').style.display = 'block';
}

function updateBasketUI() {
    document.getElementById('basketCount').innerText = basket.length;
    let itemsDiv = document.getElementById('basketItems');
    let total = 0;
    
    itemsDiv.innerHTML = basket.map((item, i) => {
        total += Number(item.price);
        return `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>${item.name}</span>
                    <span>â‚±${item.price.toLocaleString()} 
                    <button onclick="removeFromBasket(${i})" style="color:red; background:none; padding:0 5px;">x</button></span>
                </div>`;
    }).join('');
    
    document.getElementById('basketTotal').innerText = total.toLocaleString();
}

function removeFromBasket(index) {
    basket.splice(index, 1);
    updateBasketUI();
    if(basket.length === 0) toggleBasketModal();
}

function toggleBasketModal() {
    const modal = document.getElementById('basketModal');
    modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
}

// DITO MAPUPUNTA SA ADMIN ANG ORDER
function sendOrder() {
    if(basket.length === 0) return alert("Walang laman ang basket!");

    let message = "HELLO ADMIN, GUSTO KO PONG UMORDER:\n\n";
    let total = 0;
    
    basket.forEach(item => {
        message += `- ${item.name} (â‚±${item.price.toLocaleString()})\n`;
        total += Number(item.price);
    });
    
    message += `\nTOTAL: â‚±${total.toLocaleString()}`;
    
    // WhatsApp API Link
    const whatsappUrl = `https://wa.me/${ADMIN_PHONE}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}
    

</script>

</body>
  </html>

